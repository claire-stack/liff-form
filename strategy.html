<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>商品訂購表單</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select, button {
      display: block; width: 100%; margin: 6px 0 12px; padding: 10px;
      font-size: 16px; border: 1px solid #ccc; border-radius: 6px;
    }
    .product-card {
    border: 1px solid #ddd;
    padding: 20px;
    border-radius: 12px;
    background-color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    width: 85%;
    margin: 0 auto 32px;
    text-align: center;
    }

    .product-card img {
      max-width: 100%;
      width: auto;
      height: auto;
      display: block;
      margin: 0 auto 16px;
      border-radius: 10px;
    }

    .product-card h4 {
      font-size: 20px;
      margin: 12px 0;
      color: #2c3e50;
    }
    .product-card .price {
      font-size: 18px;
      color: #e67e22;
      margin-bottom: 16px;
    }
    @media (min-width: 768px) {
      .product-card {
        max-width: 600px;
      }
    }

    .message {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500;
      z-index: 1000;
    }
    .qty-row {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    }
    .qty-row input {
      width: 120px;
    }
  </style>
</head>
<body>
  <h2>商品訂購表單</h2>
  <form id="orderForm">
<!--     <label for="phone">電話<span style="color:red">*</span></label>
    <input type="text" name="phone" id="phone" required /> -->

<!--     <label for="team">團隊名稱<span style="color:red">*</span></label>
    <select name="team" id="team" required>
      <option value="">請選擇</option>
      <option value="百萬美">百萬美</option>
      <option value="億元富娜">億元富娜</option>
      <option value="戰鬥印鈔機">戰鬥印鈔機</option>
      <option value="女力崛起">女力崛起</option>
      <option value="美金團隊">美金團隊</option>
      <option value="香港 GLOW TEAM">香港 GLOW TEAM</option>
    </select> -->

<!--     <label for="name">姓名<span style="color:red">*</span></label>
    <input type="text" name="name" id="name" required />

    <label for="email">電子郵件<span style="color:red">*</span></label>
    <input type="email" name="email" id="email" required /> -->

    <!-- 商品 1 -->
    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/酵母.png" alt="商品圖片" />
      <h4> 天天酵母鋅Zn</h4>
      <p class="price">價格：<strong>$200</strong></p>
      <input type="hidden" name="Zinc_name" value="Zinc" />
      <input type="hidden" name="Zinc_price" value="200" />
      <div class="qty-row">
<!--       <label for="Zinc_qty">數量<span style="color:red">*</span></label> -->
      <label for="Zinc_qty">數量</label>
      <input type="number" name="Zinc_qty" id="Zinc_qty" min="0" step="1"/>
      </div>
    </div>

      <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/享柔.png" alt="商品圖片" />
      <h4> 享柔 G MILK</h4>
      <p class="price">價格：<strong>$670</strong></p>
      <input type="hidden" name="GMILK_name" value="GMILK" />
      <input type="hidden" name="GMILK_price" value="670" />
      <div class="qty-row">
      <label for="GMILK_qty">數量</label>
      <input type="number" name="GMILK_qty" id="GMILK_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/紫霧.png" alt="商品圖片" />
      <h4> 紫霧星辰奇蹟精華油</h4>
      <p class="price">價格：<strong>$470</strong></p>
      <input type="hidden" name="purple_name" value="purple" />
      <input type="hidden" name="purple_price" value="470" />
      <div class="qty-row">
      <label for="purple_qty">數量</label>
      <input type="number" name="purple_qty" id="purple_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/滴薑黃.png" alt="商品圖片" />
      <h4> 滴薑黃ＥＸ</h4>
      <p class="price">價格：<strong>$590</strong></p>
      <input type="hidden" name="turmeric_name" value="turmeric" />
      <input type="hidden" name="turmeric_price" value="590" />
      <div class="qty-row">
      <label for="turmeric_qty">數量</label>
      <input type="number" name="turmeric_qty" id="turmeric_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/抗痘皮脂調理霜.png" alt="商品圖片" />
      <h4> 抗痘皮脂調理霜 </h4>
      <p class="price">價格：<strong>$290</strong></p>
      <input type="hidden" name="antiacne_name" value="antiacne" />
      <input type="hidden" name="antiacne_price" value="290" />
      <div class="qty-row">
      <label for="antiacne_qty">數量</label>
      <input type="number" name="antiacne_qty" id="antiacne_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/碳酸泡泡潔膚乳.png" alt="商品圖片" />
      <h4> 碳酸泡泡潔膚乳 </h4>
      <p class="price">價格：<strong>$350</strong></p>
      <input type="hidden" name="bubble_name" value="bubble" />
      <input type="hidden" name="bubble_price" value="350" />
      <div class="qty-row">
      <label for="bubble_qty">數量</label>
      <input type="number" name="bubble_qty" id="bubble_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/超蔬洗卸凝膠.png" alt="商品圖片" />
      <h4> 超蔬洗卸凝膠 </h4>
      <p class="price">價格：<strong>$350</strong></p>
      <input type="hidden" name="remover_name" value="remover" />
      <input type="hidden" name="remover_price" value="350" />
      <div class="qty-row">
      <label for="remover_qty">數量</label>
      <input type="number" name="remover_qty" id="remover_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/熬夜霜2.0.png" alt="商品圖片" />
      <h4> 新升級熬夜霜2.0 </h4>
      <p class="price">價格：<strong>$480</strong></p>
      <input type="hidden" name="cream_name" value="cream" />
      <input type="hidden" name="cream_price" value="480" />
      <div class="qty-row">
      <label for="cream_qty">數量</label>
      <input type="number" name="cream_qty" id="cream_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/多重分裂標靶保濕精華.png" alt="商品圖片" />
      <h4> 多重分裂標靶保濕精華 </h4>
      <p class="price">價格：<strong>$500</strong></p>
      <input type="hidden" name="essence_name" value="essence" />
      <input type="hidden" name="essence_price" value="500" />
      <div class="qty-row">
      <label for="essence_qty">數量</label>
      <input type="number" name="essence_qty" id="essence_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/依克多因女神噴霧.png" alt="商品圖片" />
      <h4> 依克多因女神噴霧 </h4>
      <p class="price">價格：<strong>$290</strong></p>
      <input type="hidden" name="spray_name" value="spray" />
      <input type="hidden" name="spray_price" value="290" />
      <div class="qty-row">
      <label for="spray_qty">數量</label>
      <input type="number" name="spray_qty" id="spray_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/鹿猴倍亮白牙粉.png" alt="商品圖片" />
      <h4> 鹿猴倍亮白牙粉 </h4>
      <p class="price">價格：<strong>$240</strong></p>
      <input type="hidden" name="powder_name" value="powder" />
      <input type="hidden" name="powder_price" value="240" />
      <div class="qty-row">
      <label for="powder_qty">數量</label>
      <input type="number" name="powder_qty" id="powder_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/變變熊.png" alt="商品圖片" />
      <h4> 變變熊 </h4>
      <p class="price">價格：<strong>$400</strong></p>
      <input type="hidden" name="gummy_name" value="gummy" />
      <input type="hidden" name="gummy_price" value="400" />
      <div class="qty-row">
      <label for="gummy_qty">數量</label>
      <input type="number" name="gummy_qty" id="gummy_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/s1代加倍.png" alt="商品圖片" />
      <h4> S1 ON代加倍 </h4>
      <p class="price">價格：<strong>$390</strong></p>
      <input type="hidden" name="s1_name" value="s1" />
      <input type="hidden" name="s1_price" value="390" />
      <div class="qty-row">
      <label for="s1_qty">數量</label>
      <input type="number" name="s1_qty" id="s1_qty" min="0" step="1"/>
      </div>
    </div>

    <div class="product-card">
      <img src="https://claire-stack.github.io/liff-form/s2體減半.png" alt="商品圖片" />
      <h4> S2體減半 </h4>
      <p class="price">價格：<strong>$530</strong></p>
      <input type="hidden" name="s2_name" value="s2" />
      <input type="hidden" name="s2_price" value="530" />
      <div class="qty-row">
      <label for="s2_qty">數量</label>
      <input type="number" name="s2_qty" id="s2_qty" min="0" step="1"/>
      </div>
    </div>
    
    <button type="submit" class="submit-btn">送出</button>
    <button type="button" class="close-btn">關閉</button>
  </form>

<script>
document.addEventListener("DOMContentLoaded", function () {
  if (!navigator.userAgent.includes("Line")) {
    alert("請使用 LINE App 開啟此頁面，以使用完整功能");
    return;
  }
  initLiffAndBindForm();
});

function validateForm() {
  const form = document.getElementById("orderForm");
  let isValid = true;
  // const phoneField = document.getElementById("phone");
  // const emailField = document.getElementById("email");
  // const requiredFields = form.querySelectorAll("[required]");

  // requiredFields.forEach(field => {
  //   if (!field.value.trim()) {
  //     field.style.borderColor = "#e74c3c";
  //     isValid = false;
  //   } else {
  //     field.style.borderColor = "#27ae60";
  //   }
  // });

  // const phoneValue = phoneField.value.trim();
  // if (!/^[0-9]+$/.test(phoneValue)) {
  //   phoneField.style.borderColor = "#e74c3c";
  //   showMessage("請輸入有效的電話號碼（僅限數字）", "error");
  //   isValid = false;
  // }

  // const emailValue = emailField.value.trim();
  // const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  // if (!emailPattern.test(emailValue)) {
  //   emailField.style.borderColor = "#e74c3c";
  //   showMessage("請輸入有效的電子郵件地址", "error");
  //   isValid = false;
  // }

  const qtyFields = form.querySelectorAll('input[type="number"]');
  qtyFields.forEach(field => {
  const val = field.value.trim();
  if (val !== "" && (isNaN(val) || Number(val) < 0)) {
    field.style.borderColor = "#e74c3c";
    isValid = false;
  }
});


  return isValid;
}

async function initLiffAndBindForm() {
  const form = document.getElementById("orderForm");
  const submitBtn = document.querySelector(".submit-btn");
  const closeBtn = document.querySelector(".close-btn");
  if (!form || !submitBtn || !closeBtn) return;

  let lineUserId = null;
  try {
    await liff.init({ liffId: "2007995003-1DGmKl3x" });
    if (!liff.isInClient()) {
      alert("請透過 LINE App 開啟此表單，否則無法取得您的身份資訊");
      return;
    }
    if (!liff.isLoggedIn()) {
      liff.login(); return;
    }
    const profile = await liff.getProfile();
    lineUserId = profile.userId;
  } catch (err) {
    alert("LIFF 初始化失敗，請確認是否透過 LINE App 開啟此頁面");
    return;
  }

  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    if (!validateForm()) {
      showMessage("請填寫所有欄位並確保格式正確", "error");
      return;
    }

    submitBtn.classList.add("loading");
    submitBtn.disabled = true;

    const formData = new FormData(form);
    const data = {};
    for (let [key, value] of formData.entries()) {
      data[key] = value;
    }
    data.lineUserId = lineUserId;

    try {
      const response = await fetch("https://n8n.dg166.com/webhook/strategy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP error! status: ${response.status}, response: ${errorText}`);
      }

      const result = await response.json();
      showMessage("訂購成功！", "success");
      form.reset();
      form.querySelectorAll("input, select, button").forEach(el => el.disabled = true);
    } catch (error) {
      console.error("❌ 提交資料時發生錯誤:", error);
      showMessage("提交失敗，請稍後再試。", "error");
    } finally {
      submitBtn.classList.remove("loading");
      submitBtn.disabled = false;
    }
  });

  closeBtn.addEventListener("click", () => {
    if (confirm("確定要關閉表單嗎？未保存的資料將會遺失。")) window.close();
  });
}

function showMessage(message, type = "info") {
  const existing = document.querySelector(".message");
  if (existing) existing.remove();
  const msg = document.createElement("div");
  msg.className = `message ${type}`;
  msg.textContent = message;
  msg.style.backgroundColor = type === "error" ? "#e74c3c" : "#27ae60";
  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 3000);
}
</script>

</body>
</html>
