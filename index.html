<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>代理資料登記</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, textarea, select, button {
      display: block; width: 100%; margin: 6px 0 12px; padding: 10px;
      font-size: 16px; border: 1px solid #ccc; border-radius: 6px;
    }
    button.submit-btn.loading { background-color: #ccc; cursor: wait; }
    .message {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <h2>代理資料登記</h2>
  <form id="agentForm">
    <label for="name">姓名<span style="color:red">*</span></label>
    <input type="text" name="name" id="name" required />

    <label for="phone">電話<span style="color:red">*</span></label>
    <input type="text" name="phone" id="phone" required />

    <label for="email">電子郵件<span style="color:red">*</span></label>
    <input type="email" name="email" id="email" required />

    <label for="level">代理級別<span style="color:red">*</span></label>
    <select name="level" id="level" required>
      <option value="">請選擇</option>
      <option value="戰略">戰略</option>
      <option value="皇家">皇家</option>
      <option value="一級">一級</option>
      <option value="二級">二級</option>
      <option value="三級">三級</option>
    </select>

       <label for="team">所屬團隊<span style="color:red">*</span></label>
    <select name="team" id="team" required>
      <option value="">請選擇</option>
      <option value="百萬美">百萬美</option>
      <option value="億元富娜">億元富娜</option>
      <option value="戰鬥印鈔機">戰鬥印鈔機</option>
      <option value="女力崛起">女力崛起</option>
      <option value="美金團隊">美金團隊</option>
      <option value="香港 GLOW TEAM">香港 GLOW TEAM</option>
    </select>

    <label for="message">授權代碼<span style="color:red">*</span></label>
    <input type="text" name="code" id="code" required/>

    <label for="superior">直屬上級層級<span style="color:red">*</span></label>
    <select name="superior" id="superior" required>
      <option value="">請選擇</option>
      <option value="戰略">戰略</option>
      <option value="皇家">皇家</option>
      <option value="一級">一級</option>
      <option value="二級">二級</option>
      <option value="三級">三級</option>
    </select>

    <button type="submit" class="submit-btn">送出</button>
    <button type="button" class="close-btn">關閉</button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (!navigator.userAgent.includes("Line")) {
        alert("請使用 LINE App 開啟此頁面，以使用完整功能");
        return;
      }
      initLiffAndBindForm();
    });

    async function initLiffAndBindForm() {
      const form = document.getElementById("agentForm");
      const submitBtn = document.querySelector(".submit-btn");
      const closeBtn = document.querySelector(".close-btn");

      if (!form || !submitBtn || !closeBtn) return;

      let lineUserId = null;
      try {
        await liff.init({ liffId: "2007970219-gN63PMKn" });
        if (!liff.isInClient()) {
          alert("請透過 LINE App 開啟此表單，否則無法取得您的身份資訊");
          return;
        }
        if (!liff.isLoggedIn()) {
          liff.login(); return;
        }
        const profile = await liff.getProfile();
        lineUserId = profile.userId;
      } catch (err) {
        alert("LIFF 初始化失敗，請確認是否透過 LINE App 開啟此頁面");
        return;
      }

      const idToken = liff.getDecodedIDToken();
      if (!lineUserId && idToken?.sub) lineUserId = idToken.sub;

      closeBtn.addEventListener("click", function () {
        if (confirm("確定要關閉表單嗎？未保存的資料將會遺失。")) window.close();
      });

      function showMessage(message, type = "info") {
        const existing = document.querySelector(".message");
        if (existing) existing.remove();
        const msg = document.createElement("div");
        msg.className = `message ${type}`;
        msg.textContent = message;
        msg.style.backgroundColor = type === "error" ? "#e74c3c" : "#27ae60";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      }

      function validateForm() {
        let isValid = true;
        const phoneField = document.getElementById("phone");
        const emailField = document.getElementById("email");
        const requiredFields = form.querySelectorAll("[required]");
        requiredFields.forEach(field => {
          if (!field.value.trim()) {
            field.style.borderColor = "#e74c3c"; isValid = false;
          } else {
            field.style.borderColor = "#27ae60";
          }
        });

        const phoneValue = phoneField.value.trim();
        if (!/^[0-9]+$/.test(phoneValue)) {
          phoneField.style.borderColor = "#e74c3c";
          showMessage("請輸入有效的電話號碼（僅限數字）", "error");
          isValid = false;
        }

        const emailValue = emailField.value.trim();
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(emailValue)) {
          emailField.style.borderColor = "#e74c3c";
          showMessage("請輸入有效的電子郵件地址", "error");
          isValid = false;
        }

        return isValid;
      }

      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        if (!validateForm()) {
          showMessage("請填寫所有欄位並確保格式正確", "error");
          return;
        }

        submitBtn.classList.add("loading");
        submitBtn.disabled = true;

        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
          data[key] = value;
        }

        if (lineUserId) {
          data.lineUserId = lineUserId;
        } else {
          console.warn("⚠️ 無法取得 LINE 使用者 ID，將送出空值");
        }

        try {
          const response = await fetch("https://n8n.dg166.com/webhook/0d368ce6-652e-494d-91da-7e029c862659", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, response: ${errorText}`);
          }

          const result = await response.json();
          showMessage("資料已成功提交！", "success");
          form.reset();
        } catch (error) {
          console.error("❌ 提交資料時發生錯誤:", error);
          showMessage("提交失敗，請稍後再試。", "error");
        } finally {
          submitBtn.classList.remove("loading");
          submitBtn.disabled = false;
        }
      });
    }
  </script>
</body>
</html>
