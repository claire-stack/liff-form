<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ä»£ç†è³‡æ–™ç™»è¨˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, textarea, button {
      display: block; width: 100%; margin: 10px 0; padding: 10px;
      font-size: 16px; border: 1px solid #ccc; border-radius: 6px;
    }
    button.submit-btn.loading { background-color: #ccc; cursor: wait; }
    .message { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; }
  </style>
</head>
<body>
  <h2>ä»£ç†è³‡æ–™ç™»è¨˜</h2>
  <form id="agentForm">
    <input type="text" name="name" placeholder="å§“å" required />
    <input type="email" id="email" name="email" placeholder="é›»å­éƒµä»¶" required />
    <input type="text" id="phone" name="phone" placeholder="é›»è©±" />
    <textarea name="message" placeholder="ç•™è¨€" required></textarea>
    <button type="submit" class="submit-btn">é€å‡º</button>
    <button type="button" class="close-btn">é—œé–‰</button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (!navigator.userAgent.includes("Line")) {
        alert("è«‹ä½¿ç”¨ LINE App é–‹å•Ÿæ­¤é é¢ï¼Œä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½");
        return;
      }
      initLiffAndBindForm();
    });

    async function initLiffAndBindForm() {
      const form = document.getElementById("agentForm");
      const submitBtn = document.querySelector(".submit-btn");
      const closeBtn = document.querySelector(".close-btn");

      if (!form || !submitBtn || !closeBtn) {
        console.error("è¡¨å–®å…ƒç´ æœªæ­£ç¢ºç¶å®šï¼Œè«‹ç¢ºèª HTML çµæ§‹");
        return;
      }

      let lineUserId = null;
      try {
        await liff.init({ liffId: "2007970219-gN63PMKn" });
        console.log("âœ… LIFF åˆå§‹åŒ–æˆåŠŸ");

        if (!liff.isInClient()) {
          alert("è«‹é€é LINE App é–‹å•Ÿæ­¤è¡¨å–®ï¼Œå¦å‰‡ç„¡æ³•å–å¾—æ‚¨çš„èº«ä»½è³‡è¨Š");
          return;
        }

        if (!liff.isLoggedIn()) {
          console.warn("å°šæœªç™»å…¥ LINEï¼Œé–‹å§‹ç™»å…¥æµç¨‹");
          liff.login(); return;
        }

        const profile = await liff.getProfile();
        lineUserId = profile.userId;
        console.log("âœ… å–å¾— LINE ä½¿ç”¨è€… ID:", lineUserId);
      } catch (err) {
        console.error("âŒ LIFF åˆå§‹åŒ–æˆ– getProfile å¤±æ•—:", err);
        alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯å¦é€é LINE App é–‹å•Ÿæ­¤é é¢");
        return;
      }

      const idToken = liff.getDecodedIDToken();
      if (!lineUserId && idToken?.sub) {
        lineUserId = idToken.sub;
        console.log("ğŸ“¦ å¾ ID Token å‚™æ´å–å¾— LINE ä½¿ç”¨è€… ID:", lineUserId);
      }

      closeBtn.addEventListener("click", function () {
        if (confirm("ç¢ºå®šè¦é—œé–‰è¡¨å–®å—ï¼Ÿæœªä¿å­˜çš„è³‡æ–™å°‡æœƒéºå¤±ã€‚")) {
          window.close();
        }
      });

      function showMessage(message, type = "info") {
        const existingMessage = document.querySelector(".message");
        if (existingMessage) existingMessage.remove();

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
          padding: 12px 24px;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          background-color: ${type === "error" ? "#e74c3c" : "#27ae60"};
        `;
        document.body.appendChild(messageDiv);
        setTimeout(() => messageDiv.remove(), 3000);
      }

      function validateForm() {
        let isValid = true;
        const phoneField = document.getElementById("phone");
        const emailField = document.getElementById("email");
        const requiredFields = form.querySelectorAll("[required]");
        requiredFields.forEach(field => {
          if (!field.value.trim()) {
            field.style.borderColor = "#e74c3c"; isValid = false;
          } else {
            field.style.borderColor = "#27ae60";
          }
        });

        const phoneValue = phoneField.value.trim();
        if (phoneValue && !/^[0-9]+$/.test(phoneValue)) {
          phoneField.style.borderColor = "#e74c3c";
          showMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼ï¼ˆåƒ…é™æ•¸å­—ï¼‰", "error");
          isValid = false;
        }

        const emailValue = emailField.value.trim();
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailValue && !emailPattern.test(emailValue)) {
          emailField.style.borderColor = "#e74c3c";
          showMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€", "error");
          isValid = false;
        }

        return isValid;
      }

      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        console.log("ğŸ“¨ è¡¨å–®æäº¤äº‹ä»¶è§¸ç™¼");

        if (!validateForm()) {
          showMessage("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ä¸¦ç¢ºä¿æ ¼å¼æ­£ç¢º", "error");
          return;
        }

        submitBtn.classList.add("loading");
        submitBtn.disabled = true;

        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
          data[key] = value;
        }

        if (lineUserId) {
          data.lineUserId = lineUserId;
        } else {
          console.warn("âš ï¸ ç„¡æ³•å–å¾— LINE ä½¿ç”¨è€… IDï¼Œå°‡é€å‡ºç©ºå€¼");
        }

        console.log("ğŸ“¦ æœ€çµ‚é€å‡ºçš„è³‡æ–™:", data);

        try {
          const response = await fetch("https://n8n.dg166.com/webhook/0d368ce6-652e-494d-91da-7e029c862659", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          console.log("Webhook éŸ¿æ‡‰ç‹€æ…‹:", response.status);
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, response: ${errorText}`);
          }

          const result = await response.json();
          console.log("Webhook éŸ¿æ‡‰è³‡æ–™:", result);
          showMessage("è³‡æ–™å·²æˆåŠŸæäº¤ï¼", "success");

          form.reset();
          submitBtn.classList.remove("loading");
          submitBtn.disabled = false;
        } catch (error) {
          console.error("âŒ æäº¤è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
          showMessage("æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", "error");

          submitBtn.classList.remove("loading");
          submitBtn.disabled = false;
        }
      });
    }
  </script>
</body>
</html>
